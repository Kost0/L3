<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система учёта товаров</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        h1, h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .login-section, .main-section {
            margin-bottom: 30px;
        }

        .hidden {
            display: none;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, button {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .actions button {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 12px;
        }

        .delete-btn {
            background: #dc3545;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row input {
            flex: 1;
        }

        .user-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .error {
            color: #dc3545;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Система учёта товаров на складе</h1>

        <div id="loginSection" class="login-section">
            <h2>Вход в систему</h2>
            <div class="form-group">
                <label for="roleSelect">Выберите роль:</label>
                <select id="roleSelect">
                    <option value="admin">Администратор (admin)</option>
                    <option value="manager">Менеджер (manager)</option>
                    <option value="viewer">Наблюдатель (viewer)</option>
                </select>
            </div>
            <button onclick="login()">Войти</button>
            <div id="loginError" class="error"></div>
        </div>

        <div id="mainSection" class="main-section hidden">
            <div class="user-info">
                <strong>Текущая роль:</strong> <span id="currentRole"></span>
                <button onclick="logout()" style="float: right;">Выйти</button>
            </div>

            <div id="addItemSection">
                <h2>Добавить товар</h2>
                <div class="form-row">
                    <input type="text" id="newTitle" placeholder="Название товара">
                    <input type="number" id="newPrice" placeholder="Цена" step="0.01">
                    <input type="text" id="newCategory" placeholder="Категория">
                    <button onclick="createItem()">Добавить</button>
                </div>
                <div id="addError" class="error"></div>
                <div id="addSuccess" class="success"></div>
            </div>

            <h2>Список товаров</h2>
            <table id="itemsTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Цена</th>
                    <th>Категория</th>
                    <th>Создан</th>
                    <th>Обновлён</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
            </table>
            <div id="itemsError" class="error"></div>

            <div id="editModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; display: none;">
                <div style="background: white; padding: 30px; border-radius: 8px; min-width: 400px;">
                    <h2>Редактировать товар</h2>
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label>Название:</label>
                        <input type="text" id="editTitle" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>Цена:</label>
                        <input type="number" id="editPrice" step="0.01" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>Категория:</label>
                        <input type="text" id="editCategory" style="width: 100%;">
                    </div>
                    <button onclick="updateItem()">Сохранить</button>
                    <button onclick="closeEditModal()" style="background: #6c757d;">Отмена</button>
                    <div id="editError" class="error"></div>
                </div>
            </div>

            <div id="historyModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; display: none;">
                <div style="background: white; padding: 30px; border-radius: 8px; min-width: 800px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                    <h2>История изменений товара</h2>
                    <table style="margin-top: 20px;">
                        <thead>
                        <tr>
                            <th>Операция</th>
                            <th>Роль</th>
                            <th>Дата</th>
                            <th>Изменения</th>
                        </tr>
                        </thead>
                        <tbody id="historyModalBody"></tbody>
                    </table>
                    <div id="historyModalError" class="error"></div>
                    <button onclick="closeHistoryModal()" style="margin-top: 20px; background: #6c757d;">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        let token = null;
        let currentRole = null;

        async function login() {
            const role = document.getElementById('roleSelect').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '';

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    currentRole = role;
                    document.getElementById('currentRole').textContent = role;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainSection').classList.remove('hidden');

                    setupUI();
                    loadItems();
                } else {
                    errorDiv.textContent = 'Ошибка входа: ' + (data.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка подключения: ' + error.message;
            }
        }

        function logout() {
            token = null;
            currentRole = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('itemsBody').innerHTML = '';
        }

        function setupUI() {
            const addSection = document.getElementById('addItemSection');

            if (currentRole === 'viewer') {
                addSection.classList.add('hidden');
            } else {
                addSection.classList.remove('hidden');
            }
        }

        async function loadItems() {
            const tbody = document.getElementById('itemsBody');
            const errorDiv = document.getElementById('itemsError');
            tbody.innerHTML = '<tr><td colspan="7">Загрузка...</td></tr>';
            errorDiv.textContent = '';

            try {
                const response = await fetch(`${API_URL}/items`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    tbody.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            const editBtn = (currentRole === 'admin' || currentRole === 'manager')
                                ? `<button onclick="openEditModal('${item.uuid}', '${escapeHtml(item.title)}', ${item.price}, '${escapeHtml(item.category)}')">Редактировать</button>`
                                : '';
                            const deleteBtn = currentRole === 'admin'
                                ? `<button class="delete-btn" onclick="deleteItem('${item.uuid}')">Удалить</button>`
                                : '';
                            const historyBtn = `<button onclick="openHistoryModal('${item.uuid}')" style="background: #17a2b8;">История</button>`;

                            const actions = currentRole !== 'viewer'
                                ? `<td class="actions">${editBtn}${deleteBtn}${historyBtn}</td>`
                                : `<td class="actions">${historyBtn}</td>`;

                            row.innerHTML = `
                                <td>${item.uuid}</td>
                                <td>${escapeHtml(item.title)}</td>
                                <td>${item.price.toFixed(2)}</td>
                                <td>${escapeHtml(item.category)}</td>
                                <td>${new Date(item.created_at).toLocaleString()}</td>
                                <td>${new Date(item.updated_at).toLocaleString()}</td>
                                ${actions}
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7">Нет товаров</td></tr>';
                    }
                } else {
                    errorDiv.textContent = 'Ошибка загрузки: ' + (data.error || 'Неизвестная ошибка');
                    tbody.innerHTML = '';
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка подключения: ' + error.message;
                tbody.innerHTML = '';
            }
        }

        async function createItem() {
            const title = document.getElementById('newTitle').value.trim();
            const price = parseFloat(document.getElementById('newPrice').value);
            const category = document.getElementById('newCategory').value.trim();
            const errorDiv = document.getElementById('addError');
            const successDiv = document.getElementById('addSuccess');

            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (!title || !price || !category) {
                errorDiv.textContent = 'Заполните все поля';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/items`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, price, category })
                });

                const data = await response.json();

                if (response.ok) {
                    successDiv.textContent = 'Товар успешно добавлен';
                    document.getElementById('newTitle').value = '';
                    document.getElementById('newPrice').value = '';
                    document.getElementById('newCategory').value = '';
                    loadItems();
                } else {
                    errorDiv.textContent = 'Ошибка: ' + (data.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка подключения: ' + error.message;
            }
        }

        function openEditModal(id, title, price, category) {
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editPrice').value = price;
            document.getElementById('editCategory').value = category;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('editError').textContent = '';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').style.display = 'none';
        }

        async function updateItem() {
            const id = document.getElementById('editId').value;
            const title = document.getElementById('editTitle').value.trim();
            const price = parseFloat(document.getElementById('editPrice').value);
            const category = document.getElementById('editCategory').value.trim();
            const errorDiv = document.getElementById('editError');

            errorDiv.textContent = '';

            if (!title || !price || !category) {
                errorDiv.textContent = 'Заполните все поля';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/items/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, price, category })
                });

                const data = await response.json();

                if (response.ok) {
                    closeEditModal();
                    loadItems();
                } else {
                    errorDiv.textContent = 'Ошибка: ' + (data.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка подключения: ' + error.message;
            }
        }

        async function deleteItem(id) {
            if (!confirm('Вы уверены, что хотите удалить этот товар?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/items/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadItems();
                } else {
                    const data = await response.json();
                    alert('Ошибка удаления: ' + (data.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                alert('Ошибка подключения: ' + error.message);
            }
        }

        async function openHistoryModal(itemId) {
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').style.display = 'flex';

            const tbody = document.getElementById('historyModalBody');
            const errorDiv = document.getElementById('historyModalError');
            tbody.innerHTML = '<tr><td colspan="4">Загрузка...</td></tr>';
            errorDiv.textContent = '';

            try {
                const response = await fetch(`${API_URL}/items/history/${itemId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    tbody.innerHTML = '';

                    if (data && data.length > 0) {
                        data.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${escapeHtml(record.operation_type)}</td>
                                <td>${escapeHtml(record.role_name)}</td>
                                <td>${new Date(record.changed_at).toLocaleString()}</td>
                                <td>${escapeHtml(/*record.difference ||*/ '-')}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4">Нет записей в истории</td></tr>';
                    }
                } else {
                    const data = await response.json();
                    errorDiv.textContent = 'Ошибка: ' + (data.error || 'Не удалось загрузить историю');
                    tbody.innerHTML = '';
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка подключения: ' + error.message;
                tbody.innerHTML = '';
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>